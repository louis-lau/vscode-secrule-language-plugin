scopeName: source.seclang
name: SecLang
fileTypes:
  - conf
patterns:
  - include: '#comments'
  - include: '#directives'

repository:
  comments:
    patterns:
      - name: comment.line.number-sign.seclang
        match: '#.*$'

  directives:
    patterns:
      # SecRule directive
      - name: meta.secrule.seclang
        begin: \b(SecRule)\b
        beginCaptures:
          '1': {name: keyword.control.directive.seclang}
        end: ^(?=[^\s"])
        patterns:
          - include: '#line-continuation'
          - include: '#directives'
          - include: '#variables-with-operators'
          - include: '#operator-string'
          - include: '#action-string'
          - include: '#plain-string'

      # SecAction directive  
      - name: meta.secaction.seclang
        begin: \b(SecAction)\b
        beginCaptures:
          '1': {name: keyword.control.directive.seclang}
        end: ^(?=[^\s"])
        patterns:
          - include: '#line-continuation'
          - include: '#action-string'

      # SecDefaultAction directive with parsed action list
      - name: meta.secdefaultaction.seclang
        begin: \b(SecDefaultAction)\b
        beginCaptures:
          '1': {name: keyword.control.directive.seclang}
        end: ^(?=[^\s"])
        patterns:
          - include: '#line-continuation'
          - name: meta.actions.seclang
            begin: '"'
            beginCaptures:
              '0': {name: string.quoted.double.seclang}
            end: '(?<!\\)(?:\\\\)*"'
            endCaptures:
              '0': {name: string.quoted.double.seclang}
            patterns:
              - include: '#action-list'

      # SecRuleRemoveById, SecRuleUpdateActionById, etc. with numeric ID
      - name: meta.secrule-id-directive.seclang
        match: \b(SecRuleRemoveById|SecRuleUpdateActionById|SecRuleUpdateTargetById)\s+(\d+)
        captures:
          '1': {name: keyword.control.directive.seclang}
          '2': {name: constant.numeric.seclang}

      # Other Sec directives
      - name: keyword.control.directive.seclang
        match: \b(SecMarker|SecDefaultAction|SecRuleRemoveByMsg|SecRuleRemoveByTag|SecRuleUpdateTargetByMsg|SecRuleUpdateTargetByTag|SecRuleScript|SecComponentSignature|SecArgumentSeparator|SecArgumentsLimit|SecAuditEngine|SecAuditLog|SecAuditLog2|SecAuditLogDirMode|SecAuditLogFileMode|SecAuditLogFormat|SecAuditLogParts|SecAuditLogRelevantStatus|SecAuditLogStorageDir|SecAuditLogType|SecAuditLogPrefix|SecDebugLog|SecDebugLogLevel|SecGeoLookupDb|SecHttpBlKey|SecParseXmlIntoArgs|SecPcreMatchLimit|SecRemoteRules|SecRemoteRulesFailAction|SecRequestBodyAccess|SecRequestBodyJsonDepthLimit|SecRequestBodyLimit|SecRequestBodyNoFilesLimit|SecRequestBodyLimitAction|SecResponseBodyLimit|SecResponseBodyLimitAction|SecResponseBodyMimeType|SecResponseBodyMimeTypesClear|SecResponseBodyAccess|SecRuleEngine|SecStatusEngine|SecTmpDir|SecTmpSaveUploadedFiles|SecUnicodeMapFile|SecUploadDir|SecUploadFileLimit|SecUploadFileMode|SecUploadKeepFiles|SecWebAppId|SecXmlExternalEntity)\b

  line-continuation:
    patterns:
      - name: constant.character.escape.seclang
        match: \\$

  variables:
    patterns:
      # Macro expansion %{VARIABLE.field} or %{tx.field}
      - name: variable.other.macro.seclang
        match: (%\{)([A-Za-z_]+(?:\.[A-Za-z0-9_\-]+)*)(\})
        captures:
          '1': {name: punctuation.definition.macro.begin.seclang}
          '2': {name: variable.other.readwrite.seclang}
          '3': {name: punctuation.definition.macro.end.seclang}

      # Variable with collection parameter ARGS:param
      - name: meta.variable.collection.seclang
        match: \b([A-Z_]+:)([a-zA-Z0-9_\-\.\/\[\]]+)
        captures:
          '1': {name: variable.language.seclang}
          '2': {name: string.unquoted.seclang}

      # Variable with regex /pattern/
      - name: meta.variable.regex.seclang
        match: \b([A-Z_]+:)(/[^/\s]+/)
        captures:
          '1': {name: variable.language.seclang}
          '2': {name: string.regexp.seclang}

      # Standard variables
      - name: variable.language.seclang
        match: \b(ARGS|ARGS_COMBINED_SIZE|ARGS_GET|ARGS_GET_NAMES|ARGS_NAMES|ARGS_POST|ARGS_POST_NAMES|AUTH_TYPE|DURATION|ENV|FILES|FILES_COMBINED_SIZE|FILES_NAMES|FULL_REQUEST|FULL_REQUEST_LENGTH|FILES_SIZES|FILES_TMPNAMES|FILES_TMP_CONTENT|GEO|HIGHEST_SEVERITY|INBOUND_DATA_ERROR|MATCHED_VAR|MATCHED_VARS|MATCHED_VAR_NAME|MATCHED_VARS_NAMES|MODSEC_BUILD|MSC_PCRE_LIMITS_EXCEEDED|MULTIPART_CRLF_LF_LINES|MULTIPART_FILENAME|MULTIPART_NAME|MULTIPART_PART_HEADERS|MULTIPART_STRICT_ERROR|MULTIPART_UNMATCHED_BOUNDARY|OUTBOUND_DATA_ERROR|PATH_INFO|QUERY_STRING|REMOTE_ADDR|REMOTE_HOST|REMOTE_PORT|REMOTE_USER|REQBODY_ERROR|REQBODY_ERROR_MSG|REQBODY_PROCESSOR|REQUEST_BASENAME|REQUEST_BODY|REQUEST_BODY_LENGTH|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|REQUEST_HEADERS|REQUEST_HEADERS_NAMES|REQUEST_LINE|REQUEST_METHOD|REQUEST_PROTOCOL|REQUEST_URI|REQUEST_URI_RAW|RESPONSE_BODY|RESPONSE_CONTENT_LENGTH|RESPONSE_CONTENT_TYPE|RESPONSE_HEADERS|RESPONSE_HEADERS_NAMES|RESPONSE_PROTOCOL|RESPONSE_STATUS|RULE|SERVER_ADDR|SERVER_NAME|SERVER_PORT|SESSION|SESSIONID|STATUS_LINE|TIME|TIME_DAY|TIME_EPOCH|TIME_HOUR|TIME_MIN|TIME_MON|TIME_SEC|TIME_WDAY|TIME_YEAR|TX|UNIQUE_ID|URLENCODED_ERROR|USERID|WEBAPPID|XML)\b

  variables-with-operators:
    patterns:
      # Variable count operator &
      - name: keyword.operator.count.seclang
        match: '&'

      # Pipe separator (only in variable context, not inside strings)
      - name: keyword.operator.pipe.seclang
        match: \|

      # Negation
      - name: keyword.operator.logical.seclang
        match: '!'

      # Include all variable patterns
      - include: '#variables'

  plain-string:
    patterns:
      # Plain quoted string (implicit @rx pattern) - doesn't start with @
      - name: string.quoted.double.seclang
        match: '"(?!@)(?:[^"\\]|\\.)*"'
      
      # Plain unquoted string (no spaces) - doesn't start with quote or @
      - name: string.unquoted.seclang
        match: (?!["@])[^\s"]+
        
  operator-string:
    patterns:
      # Operators without arguments (just "@operator")
      - name: meta.operator.standalone.seclang
        match: '"(@[a-zA-Z]+)"'
        captures:
          '0': {name: string.quoted.double.seclang}
          '1': {name: support.function.seclang}
      
      # Operators with values - any operator with a space and value after it
      - name: meta.operator.value.seclang
        begin: '(")((!?)(@[a-zA-Z]+))\s+'
        beginCaptures:
          '1': {name: string.quoted.double.seclang}
          '3': {name: keyword.operator.logical.seclang}
          '4': {name: support.function.seclang}
        end: '(?<!\\)(?:\\\\)*"'
        endCaptures:
          '0': {name: string.quoted.double.seclang}
        contentName: string.unquoted.seclang
        patterns:
          - include: '#variables'

  action-string:
    patterns:
      # Action string - the quoted string with actions (doesn't start with @ and DOES contain action keywords)
      - name: meta.actions.seclang
        begin: '"(?!@)(?=(?:[^"\\]|\\.)*\b(?:id|phase|t|pass|deny|block|allow|drop|redirect|log|nolog|msg|ctl|setvar|chain):)'
        beginCaptures:
          '0': {name: string.quoted.double.seclang}
        end: '(?<!\\)(?:\\\\)*"'
        endCaptures:
          '0': {name: string.quoted.double.seclang}
        patterns:
          - include: '#line-continuation'
          - include: '#action-list'

  action-list:
    patterns:
      # Transformation t:function
      - name: meta.transformation.seclang
        match: (t:)(none|base64Decode|base64DecodeExt|base64Encode|cmdLine|compressWhitespace|cssDecode|escapeSeqDecode|hexDecode|hexEncode|htmlEntityDecode|jsDecode|length|lowercase|md5|normalisePath|normalizePath|normalisePathWin|normalizePathWin|parityEven7bit|parityOdd7bit|parityZero7bit|removeNulls|removeWhitespace|replaceComments|removeCommentsChar|removeComments|replaceNulls|sqlHexDecode|urlDecode|uppercase|urlDecodeUni|urlEncode|utf8toUnicode|sha1|trimLeft|trimRight|trim)\b
        captures:
          '1': {name: keyword.other.transformation.seclang}
          '2': {name: string.unquoted.seclang}

      # phase:N
      - name: meta.phase.seclang
        match: (phase:)(\d+|request|response|logging)\b
        captures:
          '1': {name: keyword.other.phase.seclang}
          '2': {name: constant.numeric.seclang}

      # id:'number' or id:"number" (quoted)
      - name: meta.id.seclang
        match: (id:)(['"])(\d+)(['"])
        captures:
          '1': {name: keyword.other.id.seclang}
          '2': {name: string.quoted.seclang}
          '3': {name: constant.numeric.id.seclang}
          '4': {name: string.quoted.seclang}

      # id:number
      - name: meta.id.seclang
        match: (id:)(\d+)\b
        captures:
          '1': {name: keyword.other.id.seclang}
          '2': {name: constant.numeric.id.seclang}

      # status:number
      - name: meta.status.seclang
        match: (status:)(\d+)\b
        captures:
          '1': {name: keyword.other.status.seclang}
          '2': {name: constant.numeric.seclang}

      # severity:'LEVEL' with quotes
      - name: meta.severity.seclang
        match: (severity:)(['"])([^'"]+)(['"])
        captures:
          '1': {name: keyword.other.severity.seclang}
          '2': {name: string.quoted.seclang}
          '3': {name: string.quoted.seclang}
          '4': {name: string.quoted.seclang}
      
      # severity:LEVEL without quotes
      - name: meta.severity.seclang
        match: (severity:)(\d+|EMERGENCY|ALERT|CRITICAL|ERROR|WARNING|NOTICE|INFO|DEBUG)\b
        captures:
          '1': {name: keyword.other.severity.seclang}
          '2': {name: constant.language.seclang}

      # ctl:ruleRemoveTargetById=number;ARGS:param
      - name: meta.ctl.ruleRemoveTargetById.seclang
        match: (ctl:)(ruleRemoveTargetById|ruleRemoveTargetByMsg)(=)(\d+)(;)([A-Z_]+)(:)([a-zA-Z0-9_\-\.\/\[\]]+)
        captures:
          '1': {name: keyword.control.ctl.seclang}
          '2': {name: support.function.ctl.seclang}
          '3': {name: keyword.operator.assignment.seclang}
          '4': {name: constant.numeric.seclang}
          '5': {name: punctuation.separator.semicolon.seclang}
          '6': {name: variable.language.seclang}
          '7': {name: variable.language.seclang}
          '8': {name: string.unquoted.seclang}
      
      # ctl:ruleRemoveTargetById=number;VARIABLE (without :param)
      - name: meta.ctl.ruleRemoveTargetById.seclang
        match: (ctl:)(ruleRemoveTargetById|ruleRemoveTargetByMsg)(=)(\d+)(;)([A-Z_]+)\b
        captures:
          '1': {name: keyword.control.ctl.seclang}
          '2': {name: support.function.ctl.seclang}
          '3': {name: keyword.operator.assignment.seclang}
          '4': {name: constant.numeric.seclang}
          '5': {name: punctuation.separator.semicolon.seclang}
          '6': {name: variable.language.seclang}

      # ctl:ruleRemoveTargetByTag=TAG_NAME;ARGS:param
      - name: meta.ctl.ruleRemoveTargetByTag.seclang
        match: (ctl:)(ruleRemoveTargetByTag)(=)([a-zA-Z0-9_\/\-]+)(;)([A-Z_]+)(:)([a-zA-Z0-9_\-\.\/\[\]]+)
        captures:
          '1': {name: keyword.control.ctl.seclang}
          '2': {name: support.function.ctl.seclang}
          '3': {name: keyword.operator.assignment.seclang}
          '4': {name: string.unquoted.tag.seclang}
          '5': {name: punctuation.separator.semicolon.seclang}
          '6': {name: variable.language.seclang}
          '7': {name: variable.language.seclang}
          '8': {name: string.unquoted.seclang}
      
      # ctl:ruleRemoveTargetByTag=TAG_NAME;VARIABLE (without :param)
      - name: meta.ctl.ruleRemoveTargetByTag.seclang
        match: (ctl:)(ruleRemoveTargetByTag)(=)([a-zA-Z0-9_\/\-]+)(;)([A-Z_]+)\b
        captures:
          '1': {name: keyword.control.ctl.seclang}
          '2': {name: support.function.ctl.seclang}
          '3': {name: keyword.operator.assignment.seclang}
          '4': {name: string.unquoted.tag.seclang}
          '5': {name: punctuation.separator.semicolon.seclang}
          '6': {name: variable.language.seclang}

      # Generic ctl:action
      - name: meta.ctl.seclang
        match: (ctl:)([a-zA-Z_]+)(=?)([^,"]*)
        captures:
          '1': {name: keyword.control.ctl.seclang}
          '2': {name: support.function.ctl.seclang}
          '3': {name: keyword.operator.assignment.seclang}
          '4': {name: string.unquoted.seclang}

      # msg:'text' (multi-line, single-quoted)
      - name: meta.msg.seclang
        begin: (msg:)(')
        beginCaptures:
          '1': {name: keyword.other.msg.seclang}
          '2': {name: string.quoted.seclang}
        end: (')
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#line-continuation'
          - include: '#variables'

      # msg:"text" (multi-line, double-quoted)
      - name: meta.msg.seclang
        begin: (msg:)(")
        beginCaptures:
          '1': {name: keyword.other.msg.seclang}
          '2': {name: string.quoted.seclang}
        end: (")
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#line-continuation'
          - include: '#variables'

      # tag:'text' (single-quoted)
      - name: meta.tag.seclang
        begin: (tag:)(')
        beginCaptures:
          '1': {name: keyword.other.tag.seclang}
          '2': {name: string.quoted.seclang}
        end: (')
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#variables'

      # tag:"text" (double-quoted)
      - name: meta.tag.seclang
        begin: (tag:)(")
        beginCaptures:
          '1': {name: keyword.other.tag.seclang}
          '2': {name: string.quoted.seclang}
        end: (")
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#variables'

      # logdata, ver, rev, maturity, accuracy with single quotes
      - name: meta.metadata.seclang
        begin: ((?:logdata|ver|rev|maturity|accuracy):)(')
        beginCaptures:
          '1': {name: keyword.other.metadata.seclang}
          '2': {name: string.quoted.seclang}
        end: (')
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#variables'

      # logdata, ver, rev, maturity, accuracy with double quotes
      - name: meta.metadata.seclang
        begin: ((?:logdata|ver|rev|maturity|accuracy):)(")
        beginCaptures:
          '1': {name: keyword.other.metadata.seclang}
          '2': {name: string.quoted.seclang}
        end: (")
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#variables'
      
      # tag without quotes (specific)
      - name: meta.tag.seclang
        match: (tag:)([^,"']+)
        captures:
          '1': {name: keyword.other.tag.seclang}
          '2':
            patterns:
              - include: '#variables'

      # logdata, ver, rev, maturity, accuracy without quotes (generic)
      - name: meta.metadata.seclang
        match: ((?:logdata|ver|rev|maturity|accuracy):)([^,"']+)
        captures:
          '1': {name: keyword.other.metadata.seclang}
          '2':
            patterns:
              - include: '#variables'

      # setvar:'variable=value' (single-quoted)
      - name: meta.setvar.seclang
        begin: ((?:setvar|setenv|expirevar):)(')
        beginCaptures:
          '1': {name: keyword.other.setvar.seclang}
          '2': {name: string.quoted.seclang}
        end: (')
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#variables'
          - match: '='
            name: keyword.operator.assignment.seclang

      # setvar:"variable=value" (double-quoted)
      - name: meta.setvar.seclang
        begin: ((?:setvar|setenv|expirevar):)(")
        beginCaptures:
          '1': {name: keyword.other.setvar.seclang}
          '2': {name: string.quoted.seclang}
        end: (")
        endCaptures:
          '1': {name: string.quoted.seclang}
        contentName: string.quoted.seclang
        patterns:
          - include: '#variables'
          - match: '='
            name: keyword.operator.assignment.seclang
      
      # setvar:variable=value without quotes
      - name: meta.setvar.seclang
        match: ((?:setvar|setenv|expirevar):)([^,"']+)
        captures:
          '1': {name: keyword.other.setvar.seclang}
          '2':
            patterns:
              - include: '#variables'
              - match: '='
                name: keyword.operator.assignment.seclang

      # skipAfter:label
      - name: meta.skipafter.seclang
        match: (skipAfter:)([^,"]+)
        captures:
          '1': {name: keyword.control.flow.seclang}
          '2': {name: entity.name.label.seclang}

      # skip:number
      - name: meta.skip.seclang
        match: (skip:)(\d+)
        captures:
          '1': {name: keyword.control.flow.seclang}
          '2': {name: constant.numeric.seclang}

      # initcol, setsid, setuid, setrsc
      - name: meta.init.seclang
        match: ((?:initcol|setsid|setuid|setrsc):)([^,"]+)
        captures:
          '1': {name: keyword.control.init.seclang}
          '2':
            patterns:
              - include: '#variables'

      # exec:filepath
      - name: meta.exec.seclang
        match: (exec:)([^,"]+)
        captures:
          '1': {name: keyword.control.exec.seclang}
          '2': {name: string.unquoted.filepath.seclang}

      # Disruptive actions
      - name: keyword.control.disruptive.seclang
        match: \b(allow|block|deny|drop|redirect|proxy)\b

      # Non-disruptive actions
      - name: keyword.control.action.seclang
        match: \b(log|nolog|auditlog|noauditlog|capture|chain|multiMatch|pause|pass)\b

      # Variables in actions
      - include: '#variables'

      # Comma separator
      - name: punctuation.separator.comma.seclang
        match: ','
      
      # Plain content (catch-all for regex patterns, values, etc.) - non-whitespace only
      - name: string.unquoted.seclang
        match: '[^",\\\s]+'